<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire Results Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include SheetJS and Chart.js libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Fix for table header cells */
        #resultsTable th {
            white-space: nowrap;
        }
    </style>
</head>
<body class="p-6 md:p-12">
    <!-- Language switch button container with fixed position -->
    <div style="position: fixed; top: 1.5rem; left: 1.5rem; z-index: 100;">
        <div id="langToggle" class="flex rounded-lg shadow-md overflow-hidden cursor-pointer transition-colors duration-300">
            <span id="lang-en" class="px-6 py-3 font-semibold transition-colors duration-300">English</span>
            <span id="lang-ar" class="px-6 py-3 font-semibold transition-colors duration-300">العربية</span>
        </div>
    </div>
    
    <!-- Logo at the top right -->
    <div style="position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100;">
        <img src="00.png" alt="Logo" class="h-20 w-20  shadow-md">
    </div>

    <div class="max-w-7xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 id="mainTitle" class="text-3xl font-bold text-center mb-1 text-gray-800">Questionnaire Results Analysis</h1>
        <p class="text-center text-gray-600 mb-6 text-sm" id="developerCredit">Developed by Dr. Mazen Badawy – Doctorate of TEFL</p>
        <p id="subtitle" class="text-center text-gray-600 mb-8">Upload your Excel (XLSX) file with the questionnaire results to view the analysis.</p>

        <!-- File input and loading indicator -->
        <div class="flex flex-col items-center space-y-4 mb-8">
            <label for="xlsxFile" class="block w-full text-center">
                <span id="fileButtonText" class="inline-block px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-300 cursor-pointer">
                    Choose XLSX File
                </span>
                <input type="file" id="xlsxFile" class="hidden" accept=".xlsx, .xls">
            </label>
            <div id="loadingMessage" class="hidden text-gray-500">
                Processing data, please wait...
            </div>
            <!-- Message Box for errors -->
            <div id="messageBox" class="hidden bg-red-100 border-r-4 border-red-500 text-red-700 p-4 w-full rounded-md" role="alert">
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 112 0 1 11-2z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <p class="font-bold" id="messageTitle">Error!</p>
                        <p id="messageText" class="text-sm"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- New section for domain analysis -->
        <div id="domainSection" class="hidden w-full max-w-2xl mx-auto mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 id="domainTitle" class="text-xl font-bold text-gray-700 mb-4">Domain Analysis</h2>
            <p id="domainSubtitle" class="text-gray-600 mb-4">Enter the number of items for each domain, separated by commas (e.g., 5, 3, 7).</p>
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 space-x-reverse:rtl md:space-x-reverse:ltr">
                <input type="text" id="domainInput" class="flex-1 w-full md:w-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 5, 3, 7">
                <button id="domainAnalyzeButton" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                    Analyze by Domains
                </button>
            </div>
        </div>
        
        <!-- Action buttons container (export button is now here) -->
        <div id="actionButtons" class="hidden flex flex-row justify-center space-x-4 space-x-reverse:rtl mb-8">
             <button id="exportButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300">
                Export to XLSX
            </button>
            <button id="showAllButton" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors duration-300">
                Show All Results
            </button>
        </div>


        <!-- The results table container -->
        <div id="resultsContainer" class="hidden overflow-x-auto">
            <!-- Tables for each domain will be injected here -->
        </div>

        <!-- Charts container -->
        <div id="chartContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
            <!-- Charts will be injected here -->
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const xlsxFile = document.getElementById('xlsxFile');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const chartContainer = document.getElementById('chartContainer');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const exportButton = document.getElementById('exportButton');
        const langToggle = document.getElementById('langToggle');
        const langEnSpan = document.getElementById('lang-en');
        const langArSpan = document.getElementById('lang-ar');
        const domainSection = document.getElementById('domainSection');
        const domainInput = document.getElementById('domainInput');
        const domainAnalyzeButton = document.getElementById('domainAnalyzeButton');
        const showAllButton = document.getElementById('showAllButton');
        const actionButtons = document.getElementById('actionButtons');

        // Define language data for easy switching
        const languageData = {
            en: {
                title: 'Questionnaire Results Analysis',
                subtitle: 'Upload your Excel (XLSX) file with the questionnaire results to view the analysis.',
                fileButton: 'Choose XLSX File',
                loading: 'Processing data, please wait...',
                error: 'Error!',
                fileError: 'Please select an Excel (XLSX) file.',
                parseError: 'An error occurred while processing the file. Please ensure it is a valid Excel (XLSX) file.',
                emptyFile: 'The file is empty or contains only one row.',
                langButton: 'العربية',
                exportButton: 'Export to XLSX',
                showAllButton: 'Show All Results',
                domainTitle: 'Domain Analysis',
                domainSubtitle: 'Enter the number of items for each domain, separated by commas (e.g., 5, 3, 7).',
                domainAnalyzeButton: 'Analyze by Domains',
                domainNumber: 'Domain {number}',
                domainAverages: 'Domain Averages',
                domainItemsError: 'The total number of items specified ({sum}) does not match the total number of items in the file ({total}).',
                tableHeaders: {
                    no: 'No.',
                    item: 'Item',
                    frequency: 'Frequency',
                    percentage: 'Percentage',
                    total: 'Total',
                    mean: 'Mean',
                    sd: 'SD',
                    rank: 'Rank'
                },
                chartTitle: 'Percentage Distribution of Responses',
                domainChartTitle: 'Percentage Distribution for Domain {number}'
            },
            ar: {
                title: 'تحليل نتائج الاستبيان',
                subtitle: 'قم بتحميل ملف Excel (XLSX) الخاص بنتائج الاستبيان لعرض التحليل.',
                fileButton: 'اختر ملف XLSX',
                loading: 'جاري تحميل وتحليل البيانات، يرجى الانتظار...',
                error: 'خطأ!',
                fileError: 'يرجى تحديد ملف Excel (XLSX).',
                parseError: 'حدث خطأ أثناء معالجة الملف. يرجى التأكد من أنه ملف Excel (XLSX) صحيح.',
                emptyFile: 'الملف فارغ أو يحتوي على صف واحد فقط.',
                langButton: 'English',
                exportButton: 'تصدير إلى XLSX',
                showAllButton: 'عرض جميع النتائج',
                domainTitle: 'تحليل المجالات',
                domainSubtitle: 'أدخل عدد البنود لكل مجال، مفصولة بفواصل (مثال: 5, 3, 7).',
                domainAnalyzeButton: 'تحليل حسب المجالات',
                domainNumber: 'المجال {number}',
                domainAverages: 'متوسطات المجال',
                domainItemsError: 'مجموع البنود المحددة ({sum}) لا يتطابق مع العدد الإجمالي للبنود في الملف ({total}).',
                tableHeaders: {
                    no: 'الرقم',
                    item: 'العناصر',
                    frequency: 'التكرار',
                    percentage: 'النسبة المئوية',
                    total: 'الإجمالي',
                    mean: 'المتوسط',
                    sd: 'الانحراف المعياري',
                    rank: 'الترتيب'
                },
                chartTitle: 'توزيع الاستجابات بالنسبة المئوية',
                domainChartTitle: 'توزيع الاستجابات بالنسبة المئوية للمجال {number}'
            }
        };

        // Define a mapping for Likert scale responses to numerical values.
        const responseValueMap = {
            'أوافق تماما': 5,
            'أوافق': 4,
            'أوافق إلي حد ما': 3,
            'لا أوافق': 2,
            'لا أوافق مطلقا': 1,
        };

        const responseColors = [
            'rgb(54, 162, 235)', // Light blue for positive
            'rgb(75, 192, 192)', // Green for agree
            'rgb(255, 205, 86)', // Yellow for neutral
            'rgb(255, 99, 132)', // Red for disagree
            'rgb(201, 203, 207)'  // Grey for strongly disagree
        ];
        
        let currentLang = 'en';

        // Event listener for file selection
        xlsxFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                showMessage(languageData[currentLang].fileError, 'error');
                return;
            }

            loadingMessage.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            chartContainer.classList.add('hidden');
            actionButtons.classList.add('hidden');
            domainSection.classList.add('hidden');
            messageBox.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (parsedData.length < 2) {
                        showMessage(languageData[currentLang].emptyFile, 'error');
                        return;
                    }
                    
                    // Store the parsed data in session storage to use it later without re-parsing
                    sessionStorage.setItem('parsedData', JSON.stringify(parsedData));

                    // Display the full results and chart by default
                    displayFullResults(parsedData);
                    
                    // Show the domain analysis section and action buttons
                    domainSection.classList.remove('hidden');
                    actionButtons.classList.remove('hidden');

                } catch (error) {
                    console.error("Error parsing or displaying data:", error);
                    showMessage(languageData[currentLang].parseError, 'error');
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Event listener for "Analyze by Domains" button
        domainAnalyzeButton.addEventListener('click', () => {
            const storedParsedData = JSON.parse(sessionStorage.getItem('parsedData'));
            if (!storedParsedData) {
                showMessage(languageData[currentLang].fileError, 'error');
                return;
            }

            const domainSizes = domainInput.value.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n) && n > 0);
            
            const totalItemsInFile = storedParsedData.slice(1).length;
            const totalItemsFromInput = domainSizes.reduce((sum, size) => sum + size, 0);

            if (totalItemsFromInput !== totalItemsInFile) {
                showMessage(languageData[currentLang].domainItemsError.replace('{sum}', totalItemsFromInput).replace('{total}', totalItemsInFile), 'error');
                return;
            }

            displayDomainResults(storedParsedData, domainSizes);
        });
        
        // Event listener for "Show All Results" button
        showAllButton.addEventListener('click', () => {
            const storedParsedData = JSON.parse(sessionStorage.getItem('parsedData'));
             if (storedParsedData) {
                displayFullResults(storedParsedData);
            }
        });

        // Event listener for export button
        exportButton.addEventListener('click', () => {
            exportToXLSX();
        });

        // Event listener for language toggle button
        langToggle.addEventListener('click', () => {
            toggleLanguage();
        });

        /**
         * Toggles the UI language between English and Arabic.
         */
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            setLanguage(currentLang);
            
            // Re-render the current view based on the stored data
            const storedParsedData = JSON.parse(sessionStorage.getItem('parsedData'));
            if (storedParsedData) {
                 const currentView = resultsContainer.getAttribute('data-view-mode');
                 const domainSizesInput = domainInput.value.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                 if (currentView === 'domain' && domainSizesInput.length > 0) {
                     displayDomainResults(storedParsedData, domainSizesInput);
                 } else {
                     displayFullResults(storedParsedData);
                 }
            }
        }

        /**
         * Sets all UI text and direction based on the selected language.
         * @param {string} lang The language code ('en' or 'ar').
         */
        function setLanguage(lang) {
            const text = languageData[lang];
            document.querySelector('html').lang = lang;
            document.querySelector('html').dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.title = text.title;
            document.getElementById('mainTitle').textContent = text.title;
            document.getElementById('subtitle').textContent = text.subtitle;
            document.getElementById('fileButtonText').textContent = text.fileButton;
            loadingMessage.textContent = text.loading;
            document.getElementById('messageTitle').textContent = text.error;
            exportButton.textContent = text.exportButton;
            showAllButton.textContent = text.showAllButton;
            document.getElementById('domainTitle').textContent = text.domainTitle;
            document.getElementById('domainSubtitle').textContent = text.domainSubtitle;
            domainInput.placeholder = text.domainSubtitle.split('(')[1].replace(')', '');
            domainAnalyzeButton.textContent = text.domainAnalyzeButton;

            // Apply the new button styling
            if (lang === 'ar') {
                langEnSpan.classList.remove('bg-blue-600', 'text-white');
                langEnSpan.classList.add('bg-white', 'text-blue-600');
                langArSpan.classList.remove('bg-white', 'text-blue-600');
                langArSpan.classList.add('bg-blue-600', 'text-white');
            } else {
                langEnSpan.classList.remove('bg-white', 'text-blue-600');
                langEnSpan.classList.add('bg-blue-600', 'text-white');
                langArSpan.classList.remove('bg-blue-600', 'text-white');
                langArSpan.classList.add('bg-white', 'text-blue-600');
            }
        }

        // Initial call to set the language and button style
        setLanguage(currentLang);

        /**
         * Analyzes the full dataset and displays it in a single table and pie chart.
         * @param {string[][]} data The parsed XLSX data as a 2D array.
         */
        function displayFullResults(data) {
            resultsContainer.setAttribute('data-view-mode', 'full');
            const tableHtml = createTable(data.slice(1), 'full');
            resultsContainer.innerHTML = tableHtml;
            resultsContainer.classList.remove('hidden');

            const chartData = calculatePieChartData(data.slice(1));
            renderPieChart('fullResultsChart', languageData[currentLang].chartTitle, chartData);
        }

        /**
         * Analyzes the data by domains and displays a table and pie chart for each domain.
         * @param {string[][]} data The parsed XLSX data as a 2D array.
         * @param {number[]} domainSizes An array of numbers representing the size of each domain.
         */
        function displayDomainResults(data, domainSizes) {
            resultsContainer.setAttribute('data-view-mode', 'domain');
            let itemStart = 0;
            let allTablesHtml = '';
            chartContainer.innerHTML = '';

            domainSizes.forEach((size, index) => {
                const domainData = data.slice(itemStart + 1, itemStart + 1 + size);
                const tableId = `domainTable-${index}`;
                const chartId = `domainChart-${index}`;
                
                // Add a title for the domain table
                const domainTitle = languageData[currentLang].domainNumber.replace('{number}', index + 1);
                allTablesHtml += `<h3 class="text-2xl font-bold text-gray-800 mt-8 mb-4">${domainTitle}</h3>`;
                
                // Create a table for the domain data
                allTablesHtml += createTable(domainData, tableId);
                itemStart += size;

                // Create a chart for the domain data
                const chartData = calculatePieChartData(domainData);
                const chartTitle = languageData[currentLang].domainChartTitle.replace('{number}', index + 1);
                const chartHtml = `<div class="p-6 bg-gray-50 rounded-xl shadow-inner flex flex-col justify-center items-center">
                                     <h3 class="text-lg font-semibold mb-4 text-gray-700">${chartTitle}</h3>
                                     <div class="h-64 w-full">
                                        <canvas id="${chartId}"></canvas>
                                     </div>
                                 </div>`;
                chartContainer.innerHTML += chartHtml;

            });
            resultsContainer.innerHTML = allTablesHtml;
            resultsContainer.classList.remove('hidden');
            chartContainer.classList.remove('hidden');

            // Render the charts after they are in the DOM
            domainSizes.forEach((size, index) => {
                const domainData = data.slice(index + 1, index + 1 + size); // Corrected slice for chart data
                const chartData = calculatePieChartData(domainData);
                const chartId = `domainChart-${index}`;
                const chartTitle = languageData[currentLang].domainChartTitle.replace('{number}', index + 1);
                renderPieChart(chartId, chartTitle, chartData);
            });
        }
        
        /**
         * Creates an HTML table from the given data, calculating stats.
         * @param {string[][]} data The sliced data for a specific domain or the full dataset.
         * @param {string} tableId The ID for the table element.
         * @returns {string} The HTML string for the table.
         */
        function createTable(data, tableId) {
            // First column is the items/questions, all other columns are responses.
            const items = data.map(row => row[0]);

            // Find all unique responses
            const uniqueResponses = new Set();
            data.forEach(row => {
                row.slice(1).forEach(response => {
                    if (response) {
                        uniqueResponses.add(response);
                    }
                });
            });
            const responseHeaders = Array.from(uniqueResponses).sort();

            let headerRow1Html = '<tr>';
            headerRow1Html += `<th scope="col" rowspan="2" class="px-6 py-3 border-b-2 border-gray-300">${languageData[currentLang].tableHeaders.no}</th>`;
            headerRow1Html += `<th scope="col" rowspan="2" class="px-6 py-3 border-b-2 border-gray-300">${languageData[currentLang].tableHeaders.item}</th>`;
            
            responseHeaders.forEach(header => {
                headerRow1Html += `<th scope="col" colspan="2" class="px-6 py-3 text-center border-b border-r border-l border-gray-300">${header}</th>`;
            });

            headerRow1Html += `<th scope="col" colspan="2" rowspan="2" class="px-6 py-3 text-center border-b border-r border-l border-gray-300">${languageData[currentLang].tableHeaders.total}</th>`;
            headerRow1Html += `<th scope="col" rowspan="2" class="px-6 py-3 border-b-2 border-gray-300">${languageData[currentLang].tableHeaders.mean}</th>`;
            headerRow1Html += `<th scope="col" rowspan="2" class="px-6 py-3 border-b-2 border-gray-300">${languageData[currentLang].tableHeaders.sd}</th>`;
            headerRow1Html += `<th scope="col" rowspan="2" class="px-6 py-3 border-b-2 border-gray-300">${languageData[currentLang].tableHeaders.rank}</th>`;
            headerRow1Html += '</tr>';

            let headerRow2Html = '<tr>';
            responseHeaders.forEach(() => {
                headerRow2Html += `<th scope="col" class="px-6 py-3 text-center border-b border-l border-gray-300">${languageData[currentLang].tableHeaders.frequency}</th>`;
                headerRow2Html += `<th scope="col" class="px-6 py-3 text-center border-b border-l border-gray-300">${languageData[currentLang].tableHeaders.percentage}</th>`;
            });
            headerRow2Html += '</tr>';

            let tbodyHtml = '';
            const itemStats = [];
            
            // Accumulators for domain averages
            let domainFrequencies = {};
            let domainPercentages = {};
            let domainMeans = [];
            let domainSDs = [];

            responseHeaders.forEach(header => {
                domainFrequencies[header] = 0;
                domainPercentages[header] = 0;
            });


            data.forEach((row, itemIndex) => {
                const item = row[0];
                tbodyHtml += `<tr class="bg-white border-b hover:bg-gray-50">`;
                tbodyHtml += `<td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${itemIndex + 1}</td>`;
                tbodyHtml += `<td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item}</td>`;

                const totalResponsesPerItem = row.length - 1;
                const numericResponses = [];

                responseHeaders.forEach(responseHeader => {
                    let frequency = 0;
                    row.slice(1).forEach(response => {
                        if (response === responseHeader) {
                            frequency++;
                            const numericValue = responseValueMap[response];
                            if (numericValue) {
                                numericResponses.push(numericValue);
                            }
                        }
                    });

                    const percentage = (totalResponsesPerItem > 0) ? (frequency / totalResponsesPerItem * 100) : 0;
                    
                    // Accumulate totals for domain average calculation
                    domainFrequencies[responseHeader] += frequency;
                    domainPercentages[responseHeader] += percentage;

                    tbodyHtml += `<td class="px-6 py-4 text-center border-l">${frequency}</td>`;
                    tbodyHtml += `<td class="px-6 py-4 text-center border-l">${percentage.toFixed(1)}%</td>`;
                });

                tbodyHtml += `<td class="px-6 py-4 text-center border-l font-bold text-gray-900">${totalResponsesPerItem}</td>`;
                tbodyHtml += `<td class="px-6 py-4 text-center border-l font-bold text-gray-900">100.0%</td>`;

                const n = numericResponses.length;
                let mean = 'N/A';
                let standardDeviation = 'N/A';
                
                if (n > 0) {
                    const sum = numericResponses.reduce((acc, val) => acc + val, 0);
                    mean = (sum / n);

                    if (n > 1) {
                        const sumOfSquares = numericResponses.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0);
                        const variance = sumOfSquares / (n - 1);
                        standardDeviation = Math.sqrt(variance);
                    }
                }
                
                if (!isNaN(mean) && mean !== 'N/A') {
                    domainMeans.push(mean);
                }
                if (!isNaN(standardDeviation) && standardDeviation !== 'N/A') {
                    domainSDs.push(standardDeviation);
                }
                itemStats.push({ item, mean: parseFloat(mean) });

                tbodyHtml += `<td class="px-6 py-4 text-center border-l font-bold">${mean !== 'N/A' ? mean.toFixed(2) : 'N/A'}</td>`;
                tbodyHtml += `<td class="px-6 py-4 text-center border-l font-bold">${standardDeviation !== 'N/A' ? standardDeviation.toFixed(2) : 'N/A'}</td>`;
                tbodyHtml += `<td class="px-6 py-4 text-center border-l font-bold" data-item-index="${itemIndex}"></td>`;
                tbodyHtml += `</tr>`;
            });

            // Calculate ranks after all means are computed
            const sortedStats = [...itemStats].filter(stat => !isNaN(stat.mean)).sort((a, b) => b.mean - a.mean);
            
            let rank = 1;
            const rankMap = new Map();
            for (let i = 0; i < sortedStats.length; i++) {
                if (i > 0 && sortedStats[i].mean < sortedStats[i-1].mean) {
                    rank = i + 1;
                }
                rankMap.set(sortedStats[i].item, rank);
            }
            
            // Inject ranks into the tbodyHtml
            for (let i = 0; i < data.length; i++) {
                const item = data[i][0];
                const rankValue = rankMap.get(item) || '';
                // Ensure only the rank number is inserted, without any extra characters.
                tbodyHtml = tbodyHtml.replace(`data-item-index="${i}"`, `data-item-index="${i}">${rankValue}`);
            }
            
            // --- Logic to create the domain average row ---
            let tfootHtml = `<tfoot class="bg-gray-100 font-bold text-gray-900"><tr>`;
            tfootHtml += `<td colspan="2" class="px-6 py-4 text-center border-t-2 border-gray-300">${languageData[currentLang].domainAverages}</td>`;

            responseHeaders.forEach(header => {
                const avgFrequency = (domainFrequencies[header] / data.length).toFixed(1);
                const avgPercentage = (domainPercentages[header] / data.length).toFixed(1);
                tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300">${avgFrequency}</td>`;
                tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300">${avgPercentage}%</td>`;
            });

            // Total columns remain the same
            tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300"></td>`;
            tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300"></td>`;
            
            // Calculate and add average mean and SD
            const avgMean = domainMeans.length > 0 ? (domainMeans.reduce((sum, val) => sum + val, 0) / domainMeans.length).toFixed(2) : 'N/A';
            const avgSD = domainSDs.length > 0 ? (domainSDs.reduce((sum, val) => sum + val, 0) / domainSDs.length).toFixed(2) : 'N/A';

            tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300">${avgMean}</td>`;
            tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300">${avgSD}</td>`;
            tfootHtml += `<td class="px-6 py-4 text-center border-l border-t-2 border-gray-300"></td>`; // Empty cell for Rank
            tfootHtml += `</tr></tfoot>`;
            // --- End of new logic ---

            return `<table id="${tableId}" class="w-full text-sm text-right text-gray-500 rounded-lg overflow-hidden my-4">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            ${headerRow1Html + headerRow2Html}
                        </thead>
                        <tbody>
                            ${tbodyHtml}
                        </tbody>
                        ${tfootHtml}
                    </table>`;
        }

        /**
         * Calculates the data needed for a pie chart from a given dataset.
         * @param {string[][]} data The dataset (e.g., all items or a single domain's items).
         * @returns {object} An object with labels and data for Chart.js.
         */
        function calculatePieChartData(data) {
            const responseCounts = {};
            let totalResponses = 0;

            const responseLabels = Object.keys(responseValueMap).sort((a,b) => responseValueMap[b] - responseValueMap[a]);

            responseLabels.forEach(label => responseCounts[label] = 0);

            data.forEach(row => {
                row.slice(1).forEach(response => {
                    if (responseLabels.includes(response)) {
                        responseCounts[response]++;
                        totalResponses++;
                    }
                });
            });

            const percentages = responseLabels.map(label => (responseCounts[label] / totalResponses * 100).toFixed(1));
            
            return {
                labels: responseLabels,
                datasets: [{
                    data: percentages,
                    backgroundColor: responseColors.slice(0, responseLabels.length),
                    hoverOffset: 4
                }]
            };
        }

        /**
         * Renders a pie chart on a canvas.
         * @param {string} canvasId The ID of the canvas element.
         * @param {string} chartTitle The title of the chart.
         * @param {object} chartData The data object for Chart.js.
         */
        function renderPieChart(canvasId, chartTitle, chartData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas with ID '${canvasId}' not found.`);
                return;
            }
            
            // Check if a chart instance already exists and destroy it to prevent duplicates
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            const chartConfig = {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 16,
                                family: 'Inter, sans-serif'
                            }
                        }
                    }
                }
            };
            new Chart(canvas, chartConfig);
        }

        /**
         * Exports the results table(s) to an XLSX file.
         */
        function exportToXLSX() {
            const workbook = XLSX.utils.book_new();
            
            const currentView = resultsContainer.getAttribute('data-view-mode');
            if (currentView === 'domain') {
                const tables = resultsContainer.querySelectorAll('table');
                const ws = XLSX.utils.aoa_to_sheet([]);
                let rowIndex = 0;

                tables.forEach((table, index) => {
                    // Add the domain title
                    const domainTitleText = languageData[currentLang].domainNumber.replace('{number}', index + 1);
                    XLSX.utils.sheet_add_aoa(ws, [[domainTitleText]], { origin: rowIndex });
                    rowIndex += 2; // Move to the next row, leaving one empty row

                    // Add the table content
                    XLSX.utils.sheet_add_dom(ws, table, { origin: rowIndex });
                    rowIndex += table.querySelectorAll('tr').length + 2; // Move past the table and add two empty rows
                });
                
                XLSX.utils.book_append_sheet(workbook, ws, "Domain Analysis");

            } else {
                // Use the main table
                const tableHtml = createTable(JSON.parse(sessionStorage.getItem('parsedData')).slice(1), 'resultsTable');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = tableHtml;
                const fullTable = tempDiv.querySelector('table');
                const worksheet = XLSX.utils.table_to_sheet(fullTable);
                XLSX.utils.book_append_sheet(workbook, worksheet, "All Results");
            }

            XLSX.writeFile(workbook, 'questionnaire_results.xlsx');
        }
        
        /**
         * Displays a message in the message box.
         * @param {string} text The message to display.
         * @param {string} type The type of message ('success' or 'error').
         */
        function showMessage(text, type) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            if (type === 'error') {
                messageBox.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            }
        }
    </script>
</body>
</html>
